#!/usr/bin/env python
# coding: utf-8

# ### –ó–∞–≥—Ä—É–∑–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤—å—Ç–µ –∏—Ö –∫ –∞–Ω–∞–ª–∏–∑—É

# –ó–∞–≥—Ä—É–∑–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –æ –≤–∏–∑–∏—Ç–∞—Ö, –∑–∞–∫–∞–∑–∞—Ö –∏ —Ä–µ–∫–ª–∞–º–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–∞—Ö –∏–∑ CSV-—Ñ–∞–π–ª–æ–≤ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ.
# 
# **–ü—É—Ç–∏ –∫ —Ñ–∞–π–ª–∞–º**
# 
# - –≤–∏–∑–∏—Ç—ã: `/datasets/visits_info_short.csv`.¬†[–°–∫–∞—á–∞—Ç—å –¥–∞—Ç–∞—Å–µ—Ç](https://code.s3.yandex.net/datasets/visits_info_short.csv);
# - –∑–∞–∫–∞–∑—ã: `/datasets/orders_info_short.csv`.¬†[–°–∫–∞—á–∞—Ç—å –¥–∞—Ç–∞—Å–µ—Ç](https://code.s3.yandex.net/datasets/orders_info_short.csv);
# - —Ä–∞—Å—Ö–æ–¥—ã: `/datasets/costs_info_short.csv`.¬†[–°–∫–∞—á–∞—Ç—å –¥–∞—Ç–∞—Å–µ—Ç](https://code.s3.yandex.net/datasets/costs_info_short.csv).
# 
# –ò–∑—É—á–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫—É. –ï—Å—Ç—å –ª–∏ –≤ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–ø—É—Å–∫–∏ –∏ –¥—É–±–ª–∏–∫–∞—Ç—ã? –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö –≤–æ –≤—Å–µ—Ö –∫–æ–ª–æ–Ω–∫–∞—Ö¬†—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–º –≤ –Ω–∏—Ö –∑–Ω–∞—á–µ–Ω–∏—è–º. –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ —Å—Ç–æ–ª–±—Ü—ã —Å –¥–∞—Ç–æ–π –∏ –≤—Ä–µ–º–µ–Ω–µ–º.

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –∏ –∑–∞–≥—Ä—É–∑–∏–º –¥–∞–Ω–Ω—ã–µ

# In[223]:


import pandas as pd
import matplotlib.pyplot as plt
from datetime import datetime, timedelta
import seaborn as sns
from matplotlib import pyplot as plt
import numpy as np
get_ipython().run_line_magic('matplotlib', 'inline')


# In[224]:


visits = pd.read_csv('/datasets/visits_info_short.csv')
orders = pd.read_csv('/datasets/orders_info_short.csv')
costs = pd.read_csv('/datasets/costs_info_short.csv')


# In[225]:


print(visits)
print(orders)
print(costs)


# –ü—Ä–∏–≤–µ–¥–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è —Å—Ç–æ–ª–±—Ü–æ–≤ –∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º—É –≤–∏–¥—É

# In[226]:


visits.columns = map(str.lower, visits.columns)
orders.columns = map(str.lower, orders.columns)
costs.columns = map(str.lower, costs.columns)


# In[227]:


visits = visits.rename(columns={'user id':'user_id', 'session start': 'session_st', 'session end': 'session_end' })
orders = orders.rename(columns={'user id': 'user_id', 'event dt': 'event_dt'})


# –ü—Ä–æ–≤–µ—Ä–∏–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –ø—Ä–æ–ø—É—Å–∫–æ–≤

# In[228]:


visits.isna().sum()


# In[229]:


orders.isna().sum()


# In[230]:


costs.isna().sum()


# –ü—Ä–æ–ø—É—Å–∫–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç

# –ü—Ä–æ–≤–µ—Ä–∏–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤

# In[231]:


visits.duplicated().sum()


# In[232]:


orders.duplicated().sum()


# In[233]:


costs.duplicated().sum()


# –î—É–±–ª–∏–∫–∞—Ç—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç

# –ü—Ä–æ–≤–µ—Ä–∏–º —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö

# In[234]:


visits.info()


# –í —Å—Ç–æ–ª–±—Ü–∞—Ö —Å –¥–∞—Ç–æ–π –∏ –≤—Ä–µ–º–µ–Ω–µ–º –Ω–µ–≤–µ—Ä–Ω—ã–π —Ç–∏–ø, –∏–∑–º–µ–Ω–∏–º –µ–≥–æ

# In[235]:


visits['session_st'] = pd.to_datetime(visits['session_st'])
visits['session_end'] = pd.to_datetime(visits['session_end'])
visits.info()


# In[236]:


orders.info()


# –ò–∑–º–µ–Ω–∏–º —Ç–∏–ø –¥–∞–Ω–Ω—ã—Ö –≤ —Å—Ç–æ–ª–±—Ü–µ event_dt

# In[237]:


orders['event_dt'] = pd.to_datetime(orders['event_dt'])
orders['event_dt'] 


# –ù–∞ –¥–∞–Ω–Ω–æ–º —ç—Ç–∞–ø–µ –±—ã–ª–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:
# - –∑–∞–≥—Ä—É–∂–µ–Ω—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∞–Ω–Ω—ã–µ
# - –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –±–µ–±–ª–∏–æ—Ç–µ–∫–∏
# - –Ω–∞–∑–≤–∞–Ω–∏—è —Å—Ç–æ–ª–±—Ü–æ–≤ –ø—Ä–∏–≤–µ–¥–µ–Ω—ã –∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º—É –≤–∏–¥—É
# - –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –ø—Ä–æ–ø—É—Å–∫–æ–≤ –∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
# - –∏–∑–º–µ–Ω–µ–Ω—ã —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö –≤ —Å—Ç–æ–ª–±—Ü–∞—Ö –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Ç–∞–±–ª–∏—Ü
# 

# ### –ó–∞–¥–∞–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –∏ –∞–Ω–∞–ª–∏–∑–∞ LTV, ROI, —É–¥–µ—Ä–∂–∞–Ω–∏—è –∏ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏.
# 
# –†–∞–∑—Ä–µ—à–∞–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏, —Å –∫–æ—Ç–æ—Ä—ã–º–∏ –≤—ã –ø–æ–∑–Ω–∞–∫–æ–º–∏–ª–∏—Å—å –≤ —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏—Ö —É—Ä–æ–∫–∞—Ö.
# 
# –≠—Ç–æ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏–π –º–µ—Ç—Ä–∏–∫:
# 
# - `get_profiles()` ‚Äî –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π,
# - `get_retention()` ‚Äî –¥–ª—è –ø–æ–¥—Å—á—ë—Ç–∞ Retention Rate,
# - `get_conversion()` ‚Äî –¥–ª—è –ø–æ–¥—Å—á—ë—Ç–∞ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏,
# - `get_ltv()` ‚Äî –¥–ª—è –ø–æ–¥—Å—á—ë—Ç–∞ LTV.
# 
# –ê —Ç–∞–∫–∂–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤:
# 
# - `filter_data()` ‚Äî –¥–ª—è —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö,
# - `plot_retention()` ‚Äî –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞ Retention Rate,
# - `plot_conversion()` ‚Äî –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏,
# - `plot_ltv_roi` ‚Äî –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ LTV –∏ ROI.

# –í—ã–∑–æ–≤–µ–º —Ñ—É–Ω–∫—Ü–∏—é get_profiles(), —á—Ç–æ–±—ã —Å–æ—Å—Ç–∞–≤–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ –¥–∞–Ω–Ω—ã–º —Å–µ—Å—Å–∏–π –∏–∑ –¥–∞—Ç–∞—Ñ—Ä–µ–π–º–∞

# In[238]:


# –¥–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä ad_costs ‚Äî —Ç—Ä–∞—Ç—ã –Ω–∞ —Ä–µ–∫–ª–∞–º—É
def get_profiles(sessions, orders, ad_costs):

    # —Å–æ—Ä—Ç–∏—Ä—É–µ–º —Å–µ—Å—Å–∏–∏ –ø–æ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –¥–∞—Ç–µ –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è
    # –≥—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ ID –∏ –Ω–∞—Ö–æ–¥–∏–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–µ—Ä–≤—ã—Ö –ø–æ—Å–µ—â–µ–Ω–∏–π
    profiles = (
        visits.sort_values(by=['user_id', 'session_st'])
        .groupby('user_id')
        .agg(
            {
                'session_st': 'first',
                'channel': 'first',
                'device': 'first',
                'region': 'first',
            }
        )
         # –≤—Ä–µ–º—è –ø–µ—Ä–≤–æ–≥–æ –ø–æ—Å–µ—â–µ–Ω–∏—è –Ω–∞–∑–æ–≤—ë–º first_ts
        .rename(columns={'session_st': 'first_ts'})
        .reset_index()  # –≤–æ–∑–≤—Ä–∞—â–∞–µ–º user_id –∏–∑ –∏–Ω–¥–µ–∫—Å–∞
    )

    # –¥–ª—è –∫–æ–≥–æ—Ä—Ç–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–∞—Ç—É –ø–µ—Ä–≤–æ–≥–æ –ø–æ—Å–µ—â–µ–Ω–∏—è
    # –∏ –ø–µ—Ä–≤—ã–π –¥–µ–Ω—å –º–µ—Å—è—Ü–∞, –≤ –∫–æ—Ç–æ—Ä—ã–π —ç—Ç–æ –ø–æ—Å–µ—â–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–æ—à–ª–æ
    profiles['dt'] = profiles['first_ts'].dt.date
    profiles['month'] = profiles['first_ts'].astype('datetime64[M]')

    # –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–∑–Ω–∞–∫ –ø–ª–∞—Ç—è—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    profiles['payer'] = profiles['user_id'].isin(orders['user_id'].unique())

    # —Å—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    # —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º –∏ –¥–∞—Ç–æ–π –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è
    new_users = (
        profiles.groupby(['dt', 'channel'])
        .agg({'user_id': 'nunique'})
         # —Å—Ç–æ–ª–±–µ—Ü —Å —á–∏—Å–ª–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–∞–∑–æ–≤—ë–º unique_users
        .rename(columns={'user_id': 'unique_users'})
        .reset_index()  # –≤–æ–∑–≤—Ä–∞—â–∞–µ–º dt –∏ channel –∏–∑ –∏–Ω–¥–µ–∫—Å–æ–≤
    )

    # –æ–±—ä–µ–¥–∏–Ω—è–µ–º —Ç—Ä–∞—Ç—ã –Ω–∞ —Ä–µ–∫–ª–∞–º—É –∏ —á–∏—Å–ª–æ –ø—Ä–∏–≤–ª–µ—á—ë–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    # –ø–æ –¥–∞—Ç–µ –∏ –∫–∞–Ω–∞–ª—É –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è
    ad_costs = ad_costs.merge(new_users, on=['dt', 'channel'], how='left')

    # –¥–µ–ª–∏–º —Ä–µ–∫–ª–∞–º–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã –Ω–∞ —á–∏—Å–ª–æ –ø—Ä–∏–≤–ª–µ—á—ë–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    # —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω–∏–º –≤ —Å—Ç–æ–ª–±–µ—Ü acquisition_cost (CAC)
    ad_costs['acquisition_cost'] = ad_costs['costs'] / ad_costs['unique_users']

    # –¥–æ–±–∞–≤–∏–º —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è –≤ –ø—Ä–æ—Ñ–∏–ª–∏
    profiles = profiles.merge(
        ad_costs[['dt', 'channel', 'acquisition_cost']],
        on=['dt', 'channel'],
        how='left',
    )

    # –æ—Ä–≥–∞–Ω–∏—á–µ—Å–∫–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ —Å–≤—è–∑–∞–Ω—ã —Å –¥–∞–Ω–Ω—ã–º–∏ –æ —Ä–µ–∫–ª–∞–º–µ,
    # –ø–æ—ç—Ç–æ–º—É –≤ —Å—Ç–æ–ª–±—Ü–µ acquisition_cost —É –Ω–∏—Ö –∑–Ω–∞—á–µ–Ω–∏—è NaN
    # –∑–∞–º–µ–Ω–∏–º –∏—Ö –Ω–∞ –Ω–æ–ª—å, –≤–µ–¥—å —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è —Ä–∞–≤–Ω–∞ –Ω—É–ª—é
    profiles['acquisition_cost'] = profiles['acquisition_cost'].fillna(0)
    
    return profiles  # –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—Ä–æ—Ñ–∏–ª–∏ —Å CAC


# –í—ã–∑–æ–≤–µ–º —Ñ—É–∫–Ω—Ü–∏—é –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞ —É–¥–µ—Ä–∂–∞–Ω–∏—è

# In[239]:


def get_retention(
    profiles,
    sessions,
    observation_date,
    horizon_days,
    dimensions=[],  # –Ω–æ–≤—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä dimensions
    ignore_horizon=False,
):

    # –∏—Å–∫–ª—é—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –Ω–µ ¬´–¥–æ–∂–∏–≤—à–∏—Ö¬ª –¥–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞
    last_suitable_acquisition_date = observation_date
    if not ignore_horizon:
        last_suitable_acquisition_date = observation_date - timedelta(
            days=horizon_days - 1
        )
    result_raw = profiles.query('dt <= @last_suitable_acquisition_date')

    # —Å–æ–±–∏—Ä–∞–µ–º ¬´—Å—ã—Ä—ã–µ¬ª –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ —É–¥–µ—Ä–∂–∞–Ω–∏—è
    result_raw = result_raw.merge(
        sessions[['user_id', 'session_st']], on='user_id', how='left'
    )
    result_raw['lifetime'] = (
        result_raw['session_st'] - result_raw['first_ts']
    ).dt.days

    # —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —É–¥–µ—Ä–∂–∞–Ω–∏–µ
    # –Ω–æ–≤—ã–π –≤–∞—Ä–∏–∞–Ω—Ç —Å dimensions
    result_grouped = result_raw.pivot_table(
        index=dimensions,  # –∑–∞–º–µ–Ω–∏–ª–∏ dt
        columns='lifetime',
        values='user_id',
        aggfunc='nunique',
    )
    cohort_sizes = (
        result_raw.groupby(dimensions)  # –∑–∞–º–µ–Ω–∏–ª–∏ dt
        .agg({'user_id': 'nunique'})
        .rename(columns={'user_id': 'cohort_size'})
    )
    result_grouped = cohort_sizes.merge(
        result_grouped, on=dimensions, how='left'  # –∑–∞–º–µ–Ω–∏–ª–∏ dt
    ).fillna(0)
    result_grouped = result_grouped.div(result_grouped['cohort_size'], axis=0)

    # –∏—Å–∫–ª—é—á–∞–µ–º –≤—Å–µ –ª–∞–π—Ñ—Ç–∞–π–º—ã, –ø—Ä–µ–≤—ã—à–∞—é—â–∏–µ –≥–æ—Ä–∏–∑–æ–Ω—Ç –∞–Ω–∞–ª–∏–∑–∞
    result_grouped = result_grouped[
        ['cohort_size'] + list(range(horizon_days))
    ]
    # –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–æ–ª–±–µ—Ü —Å —Ä–∞–∑–º–µ—Ä–∞–º–∏ –∫–æ–≥–æ—Ä—Ç
    result_grouped['cohort_size'] = cohort_sizes

    # –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–∞–±–ª–∏—Ü—É —É–¥–µ—Ä–∂–∞–Ω–∏—è –∏ —Å—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ
    return result_raw, result_grouped


# –í—ã–∑–æ–≤–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏

# In[240]:


def get_conversion(
    profiles,
    orders,
    observation_date,
    analysis_horizon,
    dimensions=[],
    ignore_horizon=False,
):

    # –∏—Å–∫–ª—é—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –Ω–µ ¬´–¥–æ–∂–∏–≤—à–∏—Ö¬ª –¥–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞
    last_suitable_acquisition_date = observation_date
    if not ignore_horizon:
        last_suitable_acquisition_date = observation_date - timedelta(
            days=analysis_horizon - 1
        )
    result_raw = profiles.query('dt <= @last_suitable_acquisition_date')

    # –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è –ø–µ—Ä–≤–æ–π –ø–æ–∫—É–ø–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    first_purchases = (
        orders.sort_values(by=['user_id', 'event_dt'])
        .groupby('user_id')
        .agg({'event_dt': 'first'})
        .reset_index()
    )

    # –¥–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ –ø–æ–∫—É–ø–∫–∞—Ö –≤ –ø—Ä–æ—Ñ–∏–ª–∏
    result_raw = result_raw.merge(
        first_purchases[['user_id', 'event_dt']], on='user_id', how='left'
    )

    # —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ª–∞–π—Ñ—Ç–∞–π–º –¥–ª—è –∫–∞–∂–¥–æ–π –ø–æ–∫—É–ø–∫–∏
    result_raw['lifetime'] = (
        result_raw['event_dt'] - result_raw['first_ts']
    ).dt.days

    # –≥—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ cohort, –µ—Å–ª–∏ –≤ dimensions –Ω–∏—á–µ–≥–æ –Ω–µ—Ç
    if len(dimensions) == 0:
        result_raw['cohort'] = 'All users' 
        dimensions = dimensions + ['cohort']

    # —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã –ø–æ –∂–µ–ª–∞–µ–º—ã–º –ø—Ä–∏–∑–Ω–∞–∫–∞–º
    def group_by_dimensions(df, dims, analysis_horizon):
        result = df.pivot_table(
            index=dims, columns='lifetime', values='user_id', aggfunc='nunique'
        )
        result = result.fillna(0).cumsum(axis=1)
        cohort_sizes = (
            df.groupby(dims)
            .agg({'user_id': 'nunique'})
            .rename(columns={'user_id': 'cohort_size'})
        )
        result = cohort_sizes.merge(result, on=dims, how='left').fillna(0)
        # –¥–µ–ª–∏–º –∫–∞–∂–¥—É—é ¬´—è—á–µ–π–∫—É¬ª –≤ —Å—Ç—Ä–æ–∫–µ –Ω–∞ —Ä–∞–∑–º–µ—Ä –∫–æ–≥–æ—Ä—Ç—ã
        # –∏ –ø–æ–ª—É—á–∞–µ–º conversion rate
        result = result.div(result['cohort_size'], axis=0)
        result = result[['cohort_size'] + list(range(analysis_horizon))]
        result['cohort_size'] = cohort_sizes
        return result

    # –ø–æ–ª—É—á–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –∫–æ–Ω–≤–µ—Ä—Å–∏–∏
    result_grouped = group_by_dimensions(result_raw, dimensions, analysis_horizon)

    # –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã –¥–∏–Ω–∞–º–∏–∫–∏ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏ —É–±–∏—Ä–∞–µ–º 'cohort' –∏–∑ dimensions
    if 'cohort' in dimensions: 
        dimensions = []

    # –ø–æ–ª—É—á–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –¥–∏–Ω–∞–º–∏–∫–∏ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏
    result_in_time = group_by_dimensions(
        result_raw, dimensions + ['dt'], analysis_horizon
    )

    # –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±–µ —Ç–∞–±–ª–∏—Ü—ã –∏ —Å—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ
    return result_raw, result_grouped, result_in_time


# –í—ã–∑–æ–≤–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ ltv

# In[241]:


def get_ltv(
    profiles,
    orders,
    observation_date,
    horizon_days,
    dimensions=[],
    ignore_horizon=False,
):

    # –∏—Å–∫–ª—é—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –Ω–µ ¬´–¥–æ–∂–∏–≤—à–∏—Ö¬ª –¥–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞
    last_suitable_acquisition_date = observation_date
    if not ignore_horizon:
        last_suitable_acquisition_date = observation_date - timedelta(
            days=horizon_days - 1
        )
    result_raw = profiles.query('dt <= @last_suitable_acquisition_date')
    # –¥–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ –ø–æ–∫—É–ø–∫–∞—Ö –≤ –ø—Ä–æ—Ñ–∏–ª–∏
    result_raw = result_raw.merge(
        orders[['user_id', 'event_dt', 'revenue']], on='user_id', how='left'
    )
    # —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ª–∞–π—Ñ—Ç–∞–π–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –∫–∞–∂–¥–æ–π –ø–æ–∫—É–ø–∫–∏
    result_raw['lifetime'] = (
        result_raw['event_dt'] - result_raw['first_ts']
    ).dt.days
    # –≥—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ cohort, –µ—Å–ª–∏ –≤ dimensions –Ω–∏—á–µ–≥–æ –Ω–µ—Ç
    if len(dimensions) == 0:
        result_raw['cohort'] = 'All users'
        dimensions = dimensions + ['cohort']

    # —Ñ—É–Ω–∫—Ü–∏—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –ø–æ –∂–µ–ª–∞–µ–º—ã–º –ø—Ä–∏–∑–Ω–∞–∫–∞–º
    def group_by_dimensions(df, dims, horizon_days):
        # —Å—Ç—Ä–æ–∏–º ¬´—Ç—Ä–µ—É–≥–æ–ª—å–Ω—É—é¬ª —Ç–∞–±–ª–∏—Ü—É –≤—ã—Ä—É—á–∫–∏
        result = df.pivot_table(
            index=dims, columns='lifetime', values='revenue', aggfunc='sum'
        )
        # –Ω–∞—Ö–æ–¥–∏–º —Å—É–º–º—É –≤—ã—Ä—É—á–∫–∏ —Å –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ–º
        result = result.fillna(0).cumsum(axis=1)
        # –≤—ã—á–∏—Å–ª—è–µ–º —Ä–∞–∑–º–µ—Ä—ã –∫–æ–≥–æ—Ä—Ç
        cohort_sizes = (
            df.groupby(dims)
            .agg({'user_id': 'nunique'})
            .rename(columns={'user_id': 'cohort_size'})
        )
        # –æ–±—ä–µ–¥–∏–Ω—è–µ–º —Ä–∞–∑–º–µ—Ä—ã –∫–æ–≥–æ—Ä—Ç –∏ —Ç–∞–±–ª–∏—Ü—É –≤—ã—Ä—É—á–∫–∏
        result = cohort_sizes.merge(result, on=dims, how='left').fillna(0)
        # —Å—á–∏—Ç–∞–µ–º LTV: –¥–µ–ª–∏–º –∫–∞–∂–¥—É—é ¬´—è—á–µ–π–∫—É¬ª –≤ —Å—Ç—Ä–æ–∫–µ –Ω–∞ —Ä–∞–∑–º–µ—Ä –∫–æ–≥–æ—Ä—Ç—ã
        result = result.div(result['cohort_size'], axis=0)
        # –∏—Å–∫–ª—é—á–∞–µ–º –≤—Å–µ –ª–∞–π—Ñ—Ç–∞–π–º—ã, –ø—Ä–µ–≤—ã—à–∞—é—â–∏–µ –≥–æ—Ä–∏–∑–æ–Ω—Ç –∞–Ω–∞–ª–∏–∑–∞
        result = result[['cohort_size'] + list(range(horizon_days))]
        # –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –∫–æ–≥–æ—Ä—Ç
        result['cohort_size'] = cohort_sizes

        # —Å–æ–±–∏—Ä–∞–µ–º –¥–∞—Ç–∞—Ñ—Ä–µ–π–º —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ CAC, 
        # –¥–æ–±–∞–≤–ª—è—è –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ dimensions
        cac = df[['user_id', 'acquisition_cost'] + dims].drop_duplicates()

        # —Å—á–∏—Ç–∞–µ–º —Å—Ä–µ–¥–Ω–∏–π CAC –ø–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º –∏–∑ dimensions
        cac = (
            cac.groupby(dims)
            .agg({'acquisition_cost': 'mean'})
            .rename(columns={'acquisition_cost': 'cac'})
        )

        # —Å—á–∏—Ç–∞–µ–º ROI: –¥–µ–ª–∏–º LTV –Ω–∞ CAC
        roi = result.div(cac['cac'], axis=0)

        # —É–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫–∏ —Å –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–º ROI
        roi = roi[~roi['cohort_size'].isin([np.inf])]

        # –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –∫–æ–≥–æ—Ä—Ç –≤ —Ç–∞–±–ª–∏—Ü–µ ROI
        roi['cohort_size'] = cohort_sizes

        # –¥–æ–±–∞–≤–ª—è–µ–º CAC –≤ —Ç–∞–±–ª–∏—Ü—É ROI
        roi['cac'] = cac['cac']

        # –≤ —Ñ–∏–Ω–∞–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ –æ—Å—Ç–∞–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä—ã –∫–æ–≥–æ—Ä—Ç, CAC
        # –∏ ROI –≤ –ª–∞–π—Ñ—Ç–∞–π–º—ã, –Ω–µ –ø—Ä–µ–≤—ã—à–∞—é—â–∏–µ –≥–æ—Ä–∏–∑–æ–Ω—Ç –∞–Ω–∞–ª–∏–∑–∞
        roi = roi[['cohort_size', 'cac'] + list(range(horizon_days))]

        # –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–∞–±–ª–∏—Ü—ã LTV –∏ ROI
        return result, roi

    # –ø–æ–ª—É—á–∞–µ–º —Ç–∞–±–ª–∏—Ü—ã LTV –∏ ROI
    result_grouped, roi_grouped = group_by_dimensions(
        result_raw, dimensions, horizon_days
    )

    # –¥–ª—è —Ç–∞–±–ª–∏—Ü –¥–∏–Ω–∞–º–∏–∫–∏ —É–±–∏—Ä–∞–µ–º 'cohort' –∏–∑ dimensions
    if 'cohort' in dimensions:
        dimensions = []

    # –ø–æ–ª—É—á–∞–µ–º —Ç–∞–±–ª–∏—Ü—ã –¥–∏–Ω–∞–º–∏–∫–∏ LTV –∏ ROI
    result_in_time, roi_in_time = group_by_dimensions(
        result_raw, dimensions + ['dt'], horizon_days
    )

    return (
        result_raw,  # —Å—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ
        result_grouped,  # —Ç–∞–±–ª–∏—Ü–∞ LTV
        result_in_time,  # —Ç–∞–±–ª–∏—Ü–∞ –¥–∏–Ω–∞–º–∏–∫–∏ LTV
        roi_grouped,  # —Ç–∞–±–ª–∏—Ü–∞ ROI
        roi_in_time,  # —Ç–∞–±–ª–∏—Ü–∞ –¥–∏–Ω–∞–º–∏–∫–∏ ROI
    ) 


# –î–∞–ª–µ–µ –≤—ã–∑–æ–≤–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤

# In[242]:


# —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è —Ñ—Ä–µ–π–º–∞

def filter_data(df, window):
    # –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞ –ø—Ä–∏–º–µ–Ω—è–µ–º —Å–∫–æ–ª—å–∑—è—â–µ–µ —Å—Ä–µ–¥–Ω–µ–µ
    for column in df.columns.values:
        df[column] = df[column].rolling(window).mean() 
    return df 


# In[243]:


# —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏

def plot_conversion(conversion, conversion_history, horizon, window=7):

    # –∑–∞–¥–∞—ë–º —Ä–∞–∑–º–µ—Ä —Å–µ—Ç–∫–∏ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
    plt.figure(figsize=(15, 5))

    # –∏—Å–∫–ª—é—á–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –∫–æ–≥–æ—Ä—Ç
    conversion = conversion.drop(columns=['cohort_size'])
    # –≤ —Ç–∞–±–ª–∏—Ü–µ –¥–∏–Ω–∞–º–∏–∫–∏ –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–π –ª–∞–π—Ñ—Ç–∞–π–º
    conversion_history = conversion_history.drop(columns=['cohort_size'])[
        [horizon - 1]
    ]

    # –ø–µ—Ä–≤—ã–π –≥—Ä–∞—Ñ–∏–∫ ‚Äî –∫—Ä–∏–≤—ã–µ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏
    ax1 = plt.subplot(1, 2, 1)
    conversion.T.plot(grid=True, ax=ax1)
    plt.legend()
    plt.xlabel('–õ–∞–π—Ñ—Ç–∞–π–º')
    plt.title('–ö–æ–Ω–≤–µ—Ä—Å–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π')

    # –≤—Ç–æ—Ä–æ–π –≥—Ä–∞—Ñ–∏–∫ ‚Äî –¥–∏–Ω–∞–º–∏–∫–∞ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏
    ax2 = plt.subplot(1, 2, 2, sharey=ax1)
    columns = [
        # —Å—Ç–æ–ª–±—Ü–∞–º–∏ —Å–≤–æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã —Å—Ç–∞–Ω—É—Ç –≤—Å–µ —Å—Ç–æ–ª–±—Ü—ã –∏–Ω–¥–µ–∫—Å–∞, –∫—Ä–æ–º–µ –¥–∞—Ç—ã
        name for name in conversion_history.index.names if name not in ['dt']
    ]
    filtered_data = conversion_history.pivot_table(
        index='dt', columns=columns, values=horizon - 1, aggfunc='mean'
    )
    filter_data(filtered_data, window).plot(grid=True, ax=ax2)
    plt.xlabel('–î–∞—Ç–∞ –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è')
    plt.title('–î–∏–Ω–∞–º–∏–∫–∞ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–∞ {}-–π –¥–µ–Ω—å'.format(horizon))

    plt.tight_layout()
    plt.show() 


# In[244]:


# —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ —É–¥–µ—Ä–∂–∞–Ω–∏—è

def plot_retention(retention, retention_history, horizon, window=7):

    # –∑–∞–¥–∞—ë–º —Ä–∞–∑–º–µ—Ä —Å–µ—Ç–∫–∏ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
    plt.figure(figsize=(15, 10))

    # –∏—Å–∫–ª—é—á–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –∫–æ–≥–æ—Ä—Ç –∏ —É–¥–µ—Ä–∂–∞–Ω–∏–µ –ø–µ—Ä–≤–æ–≥–æ –¥–Ω—è
    retention = retention.drop(columns=['cohort_size', 0])
    # –≤ —Ç–∞–±–ª–∏—Ü–µ –¥–∏–Ω–∞–º–∏–∫–∏ –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–π –ª–∞–π—Ñ—Ç–∞–π–º
    retention_history = retention_history.drop(columns=['cohort_size'])[
        [horizon - 1]
    ]

    # –µ—Å–ª–∏ –≤ –∏–Ω–¥–µ–∫—Å–∞—Ö —Ç–∞–±–ª–∏—Ü—ã —É–¥–µ—Ä–∂–∞–Ω–∏—è —Ç–æ–ª—å–∫–æ payer,
    # –¥–æ–±–∞–≤–ª—è–µ–º –≤—Ç–æ—Ä–æ–π –ø—Ä–∏–∑–Ω–∞–∫ ‚Äî cohort
    if retention.index.nlevels == 1:
        retention['cohort'] = 'All users'
        retention = retention.reset_index().set_index(['cohort', 'payer'])

    # –≤ —Ç–∞–±–ª–∏—Ü–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤ ‚Äî –¥–≤–∞ —Å—Ç–æ–ª–±—Ü–∞ –∏ –¥–≤–µ —Å—Ç—Ä–æ–∫–∏, —á–µ—Ç—ã—Ä–µ —è—á–µ–π–∫–∏
    # –≤ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∏–º –∫—Ä–∏–≤—ã–µ —É–¥–µ—Ä–∂–∞–Ω–∏—è –ø–ª–∞—Ç—è—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    ax1 = plt.subplot(2, 2, 1)
    retention.query('payer == True').droplevel('payer').T.plot(
        grid=True, ax=ax1
    )
    plt.legend()
    plt.xlabel('–õ–∞–π—Ñ—Ç–∞–π–º')
    plt.title('–£–¥–µ—Ä–∂–∞–Ω–∏–µ –ø–ª–∞—Ç—è—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π')


# In[245]:


# —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ LTV –∏ ROI

def plot_ltv_roi(ltv, ltv_history, roi, roi_history, horizon, window=7):

    # –∑–∞–¥–∞—ë–º —Å–µ—Ç–∫—É –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –≥—Ä–∞—Ñ–∏–∫–æ–≤
    plt.figure(figsize=(20, 10))

    # –∏–∑ —Ç–∞–±–ª–∏—Ü—ã ltv –∏—Å–∫–ª—é—á–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –∫–æ–≥–æ—Ä—Ç
    ltv = ltv.drop(columns=['cohort_size'])
    # –≤ —Ç–∞–±–ª–∏—Ü–µ –¥–∏–Ω–∞–º–∏–∫–∏ ltv –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–π –ª–∞–π—Ñ—Ç–∞–π–º
    ltv_history = ltv_history.drop(columns=['cohort_size'])[[horizon - 1]]

    # —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è –∑–∞–ø–∏—à–µ–º –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ—Ä–µ–π–º
    cac_history = roi_history[['cac']]

    # –∏–∑ —Ç–∞–±–ª–∏—Ü—ã roi –∏—Å–∫–ª—é—á–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –∫–æ–≥–æ—Ä—Ç –∏ cac
    roi = roi.drop(columns=['cohort_size', 'cac'])
    # –≤ —Ç–∞–±–ª–∏—Ü–µ –¥–∏–Ω–∞–º–∏–∫–∏ roi –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–π –ª–∞–π—Ñ—Ç–∞–π–º
    roi_history = roi_history.drop(columns=['cohort_size', 'cac'])[
        [horizon - 1]
    ]

    # –ø–µ—Ä–≤—ã–π –≥—Ä–∞—Ñ–∏–∫ ‚Äî –∫—Ä–∏–≤—ã–µ ltv
    ax1 = plt.subplot(2, 3, 1)
    ltv.T.plot(grid=True, ax=ax1)
    plt.legend()
    plt.xlabel('–õ–∞–π—Ñ—Ç–∞–π–º')
    plt.title('LTV')

    # –≤—Ç–æ—Ä–æ–π –≥—Ä–∞—Ñ–∏–∫ ‚Äî –¥–∏–Ω–∞–º–∏–∫–∞ ltv
    ax2 = plt.subplot(2, 3, 2, sharey=ax1)
    # —Å—Ç–æ–ª–±—Ü–∞–º–∏ —Å–≤–æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã —Å—Ç–∞–Ω—É—Ç –≤—Å–µ —Å—Ç–æ–ª–±—Ü—ã –∏–Ω–¥–µ–∫—Å–∞, –∫—Ä–æ–º–µ –¥–∞—Ç—ã
    columns = [name for name in ltv_history.index.names if name not in ['dt']]
    filtered_data = ltv_history.pivot_table(
        index='dt', columns=columns, values=horizon - 1, aggfunc='mean'
    )
    filter_data(filtered_data, window).plot(grid=True, ax=ax2)
    plt.xlabel('–î–∞—Ç–∞ –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è')
    plt.title('–î–∏–Ω–∞–º–∏–∫–∞ LTV –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–∞ {}-–π –¥–µ–Ω—å'.format(horizon))

    # —Ç—Ä–µ—Ç–∏–π –≥—Ä–∞—Ñ–∏–∫ ‚Äî –¥–∏–Ω–∞–º–∏–∫–∞ cac
    ax3 = plt.subplot(2, 3, 3, sharey=ax1)
    # —Å—Ç–æ–ª–±—Ü–∞–º–∏ —Å–≤–æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã —Å—Ç–∞–Ω—É—Ç –≤—Å–µ —Å—Ç–æ–ª–±—Ü—ã –∏–Ω–¥–µ–∫—Å–∞, –∫—Ä–æ–º–µ –¥–∞—Ç—ã
    columns = [name for name in cac_history.index.names if name not in ['dt']]
    filtered_data = cac_history.pivot_table(
        index='dt', columns=columns, values='cac', aggfunc='mean'
    )
    filter_data(filtered_data, window).plot(grid=True, ax=ax3)
    plt.xlabel('–î–∞—Ç–∞ –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è')
    plt.title('–î–∏–Ω–∞–º–∏–∫–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π')

    # —á–µ—Ç–≤—ë—Ä—Ç—ã–π –≥—Ä–∞—Ñ–∏–∫ ‚Äî –∫—Ä–∏–≤—ã–µ roi
    ax4 = plt.subplot(2, 3, 4)
    roi.T.plot(grid=True, ax=ax4)
    plt.axhline(y=1, color='red', linestyle='--', label='–£—Ä–æ–≤–µ–Ω—å –æ–∫—É–ø–∞–µ–º–æ—Å—Ç–∏')
    plt.legend()
    plt.xlabel('–õ–∞–π—Ñ—Ç–∞–π–º')
    plt.title('ROI')

    # –ø—è—Ç—ã–π –≥—Ä–∞—Ñ–∏–∫ ‚Äî –¥–∏–Ω–∞–º–∏–∫–∞ roi
    ax5 = plt.subplot(2, 3, 5, sharey=ax4)
    # —Å—Ç–æ–ª–±—Ü–∞–º–∏ —Å–≤–æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã —Å—Ç–∞–Ω—É—Ç –≤—Å–µ —Å—Ç–æ–ª–±—Ü—ã –∏–Ω–¥–µ–∫—Å–∞, –∫—Ä–æ–º–µ –¥–∞—Ç—ã
    columns = [name for name in roi_history.index.names if name not in ['dt']]
    filtered_data = roi_history.pivot_table(
        index='dt', columns=columns, values=horizon - 1, aggfunc='mean'
    )
    filter_data(filtered_data, window).plot(grid=True, ax=ax5)
    plt.axhline(y=1, color='red', linestyle='--', label='–£—Ä–æ–≤–µ–Ω—å –æ–∫—É–ø–∞–µ–º–æ—Å—Ç–∏')
    plt.xlabel('–î–∞—Ç–∞ –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è')
    plt.title('–î–∏–Ω–∞–º–∏–∫–∞ ROI –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–∞ {}-–π –¥–µ–Ω—å'.format(horizon))

    plt.tight_layout()
    plt.show() 


# –ù–∞ –¥–∞–Ω–Ω–æ–º —ç—Ç–∞–ø–µ –±—ã–ª–∏ –≤—ã–∑–≤–∞–Ω—ã —Ñ—É–Ω–∫—Ü–∏–∏, –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —Ä–∞—Å—á–µ—Ç–∞ retention rate, conversion rate, –∏ ltv, –∞ —Ç–∞–∫–∂–µ –±—ã–ª–∏ –≤—ã–∑–≤–∞–Ω—ã —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤

# <div class="alert alert-success">
# <b>üëç –£—Å–ø–µ—Ö:</b> –ù—É–∂–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã!
# </div>

# ### –ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö
# 
# - –°–æ—Å—Ç–∞–≤—å—Ç–µ –ø—Ä–æ—Ñ–∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. –û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –¥–∞—Ç—ã –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
# - –í—ã—è—Å–Ω–∏—Ç–µ, –∏–∑ –∫–∞–∫–∏—Ö —Å—Ç—Ä–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø—Ä–∏—Ö–æ–¥—è—Ç –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ –Ω–∞ –∫–∞–∫—É—é —Å—Ç—Ä–∞–Ω—É –ø—Ä–∏—Ö–æ–¥–∏—Ç—Å—è –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ –ø–ª–∞—Ç—è—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. –ü–æ—Å—Ç—Ä–æ–π—Ç–µ —Ç–∞–±–ª–∏—Ü—É, –æ—Ç—Ä–∞–∂–∞—é—â—É—é –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –¥–æ–ª—é –ø–ª–∞—Ç—è—â–∏—Ö –∏–∑ –∫–∞–∂–¥–æ–π —Å—Ç—Ä–∞–Ω—ã.
# - –£–∑–Ω–∞–π—Ç–µ, –∫–∞–∫–∏–º–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏ –ø–æ–ª—å–∑—É—é—Ç—Å—è –∫–ª–∏–µ–Ω—Ç—ã –∏ –∫–∞–∫–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞—é—Ç –ø–ª–∞—Ç—è—â–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏. –ü–æ—Å—Ç—Ä–æ–π—Ç–µ —Ç–∞–±–ª–∏—Ü—É, –æ—Ç—Ä–∞–∂–∞—é—â—É—é –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –¥–æ–ª—é –ø–ª–∞—Ç—è—â–∏—Ö –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞.
# - –ò–∑—É—á–∏—Ç–µ —Ä–µ–∫–ª–∞–º–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è –∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –∫–∞–Ω–∞–ª—ã, –∏–∑ –∫–æ—Ç–æ—Ä—ã—Ö –ø—Ä–∏—à–ª–æ –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ –ø–ª–∞—Ç—è—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. –ü–æ—Å—Ç—Ä–æ–π—Ç–µ —Ç–∞–±–ª–∏—Ü—É, –æ—Ç—Ä–∞–∂–∞—é—â—É—é –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –¥–æ–ª—é –ø–ª–∞—Ç—è—â–∏—Ö –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–∞–Ω–∞–ª–∞ –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è.
# 
# –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –ø—É–Ω–∫—Ç–∞ —Å—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π—Ç–µ –≤—ã–≤–æ–¥—ã.

# In[246]:


costs['dt'] = pd.to_datetime(costs['dt']).dt.date


# In[247]:


profiles = get_profiles(visits, orders, costs)

profiles['acquisition_cost'].sum()


# –°–æ—Å—Ç–∞–≤–∏–º –ø—Ä–æ—Ñ–∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –ø–æ–º–æ—â—å—é —Ñ—É–Ω–∫—Ü–∏–∏ get_profiles

# In[248]:


profiles = get_profiles(visits, orders, costs)
profiles


# In[249]:


profiles['first_ts'] = pd.to_datetime(profiles['first_ts'])
profiles['first_ts']


# –†–µ–∑—É–ª—å—Ç–∞—Ç ‚Äî 150008 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π, –≤ –∫–∞–∂–¥–æ–º –∏–∑ –∫–æ—Ç–æ—Ä—ã—Ö –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –æ –¥–∞—Ç–µ –ø–µ—Ä–≤–æ–≥–æ –ø–æ—Å–µ—â–µ–Ω–∏—è, —Ä–µ–≥–∏–æ–Ω–µ –∏ —Ä–µ–∫–ª–∞–º–Ω–æ–º –∏—Å—Ç–æ—á–Ω–∏–∫–µ, –∫–æ—Ç–æ—Ä—ã–π –º–æ—Ç–∏–≤–∏—Ä–æ–≤–∞–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ—Å–µ—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.

# –î–∞–ª–µ–µ –æ–ø—Ä–µ–¥–µ–ª–∏–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –¥–∞—Ç—ã –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

# In[250]:


min_analysis_date = profiles['dt'].min()
observation_date = profiles['dt'].max()# –≤–∞—à –∫–æ–¥ –∑–¥–µ—Å—å

print(min_analysis_date, observation_date)


# In[251]:


horizon_days =  14 
max_analysis_date =  observation_date - timedelta(days=horizon_days - 1)
print(max_analysis_date)


# –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞ - 1 –º–∞—è 2019 –≥–æ–¥–∞, –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è - 27 –æ–∫—Ç—è–±—Ä—è 2019 –≥–æ–¥–∞. –° —É—á–µ—Ç–æ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞ –≤ 14 –¥–Ω–µ–π - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –≤–æ–∑–º–æ–∂–Ω–∞—è –¥–∞—Ç–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ - 14 –æ–∫—Ç—è–±—Ä—è 2019
# 

# –°–¥–µ–ª–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –ø–æ —Å—Ç—Ä–∞–Ω–∞–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

# In[252]:


profiles.groupby('region').agg({'user_id': 'nunique', 'payer': 'mean'}).sort_values(by='user_id', ascending=False)


# –ë–æ–ª—å—à–µ –≤—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ –°–®–ê, –º–µ–Ω—å—à–µ –≤—Å–µ–≥–æ –∏–∑ –ì–µ—Ä–º–∞–Ω–∏–∏. –ë–æ–ª—å—à–µ –≤—Å–µ–≥–æ –ø–ª–∞—Ç—è—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Ç–∞–∫–∂–µ –≤ –°–®–ê, –º–µ–Ω—å—à–µ –≤—Å–µ–≥–æ - –≤–æ –§—Ä–∞–Ω—Ü–∏–∏

# –°–¥–µ–ª–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –ø–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

# In[253]:


profiles.groupby('device').agg({'user_id': 'nunique', 'payer': 'mean'}).sort_values(by='user_id', ascending=False)


# –ö–ª–∏–µ–Ω—Ç—ã —á–∞—â–µ –ø–æ–ª—å–∑—É—é—Ç—Å—è iPhone (54479), –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ –ø–ª–∞—Ç—è—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Ç–∞–∫–∂–µ –æ—Ç—Ç—É–¥–∞, —Ä–µ–∂–µ –≤—Å–µ–≥–æ - –ú–∞—Å (30042)

# <div class="alert alert-success">
# <b>üëç –£—Å–ø–µ—Ö:</b> –í—Å–µ –≤–µ—Ä–Ω–æ!
# </div>

# –°–¥–µ–ª–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –ø–æ –∫–∞–Ω–∞–ª–∞–º –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

# In[254]:


profiles.groupby('channel').agg({'user_id': 'nunique', 'payer': 'mean'}).sort_values(by='user_id', ascending=False)


# –°–∞–º—ã–π –ø–æ–ø—É–ª—è—Ä–Ω—ã–π –∫–∞–Ω–∞–ª - FaceBoom(56439), –Ω–∞–∏–º–µ–Ω–µ–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã–π - lambdaMediaAds(2149). –ë–æ–ª—å—à–µ –≤—Å–µ–≥–æ –ø–ª–∞—Ç—è—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–∏—à–ª–æ –∏–∑ –∫–∞–Ω–∞–ª–∞ FaceBoom, –º–µ–Ω—å—à–µ - –∏–∑ OppleCreativeMedia

# –í—ã–≤–æ–¥—ã
# 
# - –ë–æ–ª—å—à–µ –≤—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ –°–®–ê, –º–µ–Ω—å—à–µ –≤—Å–µ–≥–æ –∏–∑ –ì–µ—Ä–º–∞–Ω–∏–∏. –ë–æ–ª—å—à–µ –≤—Å–µ–≥–æ –ø–ª–∞—Ç—è—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –°–®–ê, –º–µ–Ω—å—à–µ –≤—Å–µ–≥–æ - –≤–æ –§—Ä–∞–Ω—Ü–∏–∏
# - –ö–ª–∏–µ–Ω—Ç—ã —á–∞—â–µ –ø–æ–ª—å–∑—É—é—Ç—Å—è iPhone (54479), –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ –ø–ª–∞—Ç—è—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Ç–∞–∫–∂–µ –æ—Ç—Ç—É–¥–∞, —Ä–µ–∂–µ –≤—Å–µ–≥–æ - –ú–∞—Å (30042). –ú–µ–Ω—å—à–µ –ø–ª–∞—Ç—è—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–∏—Ö–æ–¥–∏—Ç –∏–∑ –†–°
# - –°–∞–º—ã–π –ø–æ–ø—É–ª—è—Ä–Ω—ã–π –∫–∞–Ω–∞–ª - FaceBoom(56439), –Ω–∞–∏–º–µ–Ω–µ–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã–π - lambdaMediaAds(2149). –ë–æ–ª—å—à–µ –≤—Å–µ–≥–æ –ø–ª–∞—Ç—è—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–∏—à–ª–æ –∏–∑ –∫–∞–Ω–∞–ª–∞ FaceBoom, –º–µ–Ω—å—à–µ - –∏–∑ OppleCreativeMedia

# ### –ú–∞—Ä–∫–µ—Ç–∏–Ω–≥
# 
# - –ü–æ—Å—á–∏—Ç–∞–π—Ç–µ –æ–±—â—É—é —Å—É–º–º—É —Ä–∞—Å—Ö–æ–¥–æ–≤ –Ω–∞ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥.
# - –í—ã—è—Å–Ω–∏—Ç–µ, –∫–∞–∫ —Ç—Ä–∞—Ç—ã —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –ø–æ —Ä–µ–∫–ª–∞–º–Ω—ã–º –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º, —Ç–æ –µ—Å—Ç—å —Å–∫–æ–ª—å–∫–æ –¥–µ–Ω–µ–≥ –ø–æ—Ç—Ä–∞—Ç–∏–ª–∏ –Ω–∞ –∫–∞–∂–¥—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫.
# - –ü–æ—Å—Ç—Ä–æ–π—Ç–µ –≥—Ä–∞—Ñ–∏–∫ —Å –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–µ–π –¥–∏–Ω–∞–º–∏–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞—Å—Ö–æ–¥–æ–≤ –≤–æ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ –Ω–µ–¥–µ–ª—è–º –ø–æ –∫–∞–∂–¥–æ–º—É –∏—Å—Ç–æ—á–Ω–∏–∫—É. –ó–∞—Ç–µ–º –Ω–∞ –¥—Ä—É–≥–æ–º –≥—Ä–∞—Ñ–∏–∫–µ –≤–∏–∑—É–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –¥–∏–Ω–∞–º–∏–∫—É –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞—Å—Ö–æ–¥–æ–≤ –≤–æ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ –º–µ—Å—è—Ü–∞–º –ø–æ –∫–∞–∂–¥–æ–º—É –∏—Å—Ç–æ—á–Ω–∏–∫—É.
# - –£–∑–Ω–∞–π—Ç–µ, —Å–∫–æ–ª—å–∫–æ –≤ —Å—Ä–µ–¥–Ω–µ–º —Å—Ç–æ–∏–ª–æ –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏–µ –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (CAC) –∏–∑ –∫–∞–∂–¥–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–æ—Ñ–∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
# 
# –ù–∞–ø–∏—à–∏—Ç–µ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ –≤—ã–≤–æ–¥—ã.

# –ü–æ—Å—á–∏—Ç–∞–µ–º –æ–±—â—É—é —Å—É–º–º—É —Ä–∞—Å—Ö–æ–¥–æ–≤ –Ω–∞ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥

# In[255]:


costs['costs'].sum()


# –û–±—â–∞–∞ —Å—É–º–º–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤ –Ω–∞ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥ - 105497

# –°–¥–µ–ª–∞–µ–º —Ç–∞–±–ª–∏—Ü—É —Å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º —Ç—Ä–∞—Ç –Ω–∞ –∫–∞–∂–¥—ã–π —Ä–µ–∫–ª–∞–º–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫

# In[256]:


costs.groupby('channel').agg({'costs': 'sum'}).sort_values(by='costs', ascending=False)


# –ë–æ–ª—å—à–µ –≤—Å–µ–≥–æ –¥–µ–Ω–µ–≥ –±—ã–ª–æ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫ TipTop (54751), –º–µ–Ω—å—à–µ –≤—Å–µ–≥–æ (–µ—Å–ª–∏ –Ω–µ —É—á–∏—Ç—ã–≤–∞—Ç—å organic, —Ç.–∫. —Ç–∞–º –±—É–¥–µ—Ç 0) - YRabbit (944)

# –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –°–ê–° –ø–æ –∫–∞–Ω–∞–ª–∞–º –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è

# In[257]:


costs.pivot_table(
    index='dt', columns='channel', values='costs', aggfunc='sum'
).plot(grid=True, figsize=(10, 5))
plt.ylabel('CAC, $')
plt.xlabel('–î–∞—Ç–∞ –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è')
plt.title('–î–∏–Ω–∞–º–∏–∫–∞ –°–ê–° –ø–æ –∫–∞–Ω–∞–ª–∞–º –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è')
plt.show()


# –£ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –°–ê–° –≤–∞—Ä—å–∏—Ä–æ–≤–∞–ª–∞—Å—å –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –æ—Ç 0 –¥–æ 50 –¥–æ–ª–ª–∞—Ä–æ–≤, –æ–¥–Ω–∞–∫–æ —É –¥–≤—É—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (TipTop –∏ FaceBoom) –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å –ø—Ä–µ–≤—ã—Å–∏–ª 100 –¥–æ–ª–ª–∞—Ä–æ–≤, –∞ –≤ –Ω–∞—á–∞–ª–µ –æ–∫—Ç—è–±—Ä—è 2019 –°–ê–° TipTop –¥–æ—Å—Ç–∏–≥ 600 –¥–æ–ª–ª–∞—Ä–æ–≤

# –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∏–Ω–∞–º–∏–∫—É —Ä–∞—Å—Ö–æ–¥–æ–≤ –ø–æ –Ω–µ–¥–µ–ª—è–º

# In[258]:


costs.dt = pd.to_datetime(costs.dt)
costs['week'] = costs.dt.dt.week
costs['month'] = costs.dt.dt.month

plt.figure(figsize=(25, 7))

# –∑–∞–¥–∞–µ–º –Ω–µ–¥–µ–ª—å–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã
report_week = costs.pivot_table(index='channel', columns='week', values='costs', aggfunc='sum'
)

# –°—Ç—Ä–æ–∏–º –¥–∏–Ω–∞–º–∏–∫—É —Ä–∞—Å—Ö–æ–¥–æ–≤ –ø–æ –ù–µ–¥–µ–ª—è–º
report_week.T.plot(
    grid=True, xticks=list(report_week.columns.values), ax=plt.subplot(1, 2, 1)
)
plt.title('–î–∏–Ω–∞–º–∏–∫–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤ –ø–æ –Ω–µ–¥–µ–ª—è–º')


# –í –¥–∏–Ω–∞–º–∏–∫–µ —Ä–∞—Å—Ö–æ–¥–æ–≤ –ø–æ –Ω–µ–¥–µ–ª—è–º —Ç–∞–∫–∂–µ –≤—ã–¥–µ—è—é—Ç—Å—è –¥–≤–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ - TipTop –∏ FaceBoom, —É –æ–±–æ–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –±—ã–ª –ø–∏–∫ –ø–æ —Ä–∞—Å—Ö–æ–¥–∞–º –Ω–∞ 39 –Ω–µ–¥–µ–ª–µ

# –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–∞—Å—Ö–æ–¥—ã –ø–æ –º–µ—Å—è—Ü–∞–º

# In[259]:


plt.figure(figsize=(25, 7))
# –∑–∞–¥–∞–µ–º —Ä–∞—Å—Ö–æ–¥—ã –ø–æ –º–µ—Å—è—Ü–∞–º
report_month = costs.pivot_table(index='channel', columns='month', values='costs', aggfunc='sum')


# —Å—Ç—Ä–æ–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–æ–≤ –ø–æ –º–µ—Å—è—Ü–∞–º
report_month.T.plot(
    grid=True, xticks=list(report_month.columns.values), ax=plt.subplot(1, 2, 2)
)
plt.title('–î–∏–Ω–∞–º–∏–∫–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤ –ø–æ –º–µ—Å—è—Ü–∞–º')
plt.show()


# –ü–∏–∫ —Ä–∞—Å—Ö–æ–¥–æ–≤ –ø–æ –º–µ—Å—è—Ü–∞–º —É –¥–≤—É—Ö —Å–∞–º—ã—Ö –∑–∞—Ç—Ä–∞—Ç–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤: TipTop - —Å–µ–Ω—Ç—è–±—Ä—å, FaceBoom - –∞–≤–≥—É—Å—Ç
# 

# –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∏–Ω–∞–º–∏–∫—É —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 

# In[260]:


# —Å—Ç—Ä–æ–∏–º –≥—Ä–∞—Ñ–∏–∫ –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π CAC –ø–æ –∫–∞–Ω–∞–ª–∞–º –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è

profiles.pivot_table(
    index='dt', columns='channel', values='acquisition_cost', aggfunc='mean'
).plot(grid=True, figsize=(10, 5))
plt.ylabel('CAC, $')
plt.xlabel('–î–∞—Ç–∞ –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è')
plt.title('–î–∏–Ω–∞–º–∏–∫–∞ –°–ê–° –ø–æ –∫–∞–Ω–∞–ª–∞–º –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è')
plt.show()


# –¢–µ–ø–µ—Ä—å –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ –≤—ã–¥–µ–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –∫–∞–Ω–∞–ª –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è - TipTop, —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–µ–≤—ã—à–∞–µ—Ç 3,5$

# –ù–∞ –¥–∞–Ω–Ω–æ–º —ç—Ç–∞–ø–µ –±—ã–ª–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:
# 
# - –ü–æ—Å—á–∏—Ç–∞–Ω–∞ –æ–±—â–∞—è —Å—É–º–º–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤ –Ω–∞ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥ - 105497
# - –ë–æ–ª—å—à–µ –≤—Å–µ–≥–æ –¥–µ–Ω–µ–≥ –±—ã–ª–æ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫ TipTop (54751), –º–µ–Ω—å—à–µ –≤—Å–µ–≥–æ (–µ—Å–ª–∏ –Ω–µ —É—á–∏—Ç—ã–≤–∞—Ç—å organic, —Ç.–∫. —Ç–∞–º –±—É–¥–µ—Ç 0) - YRabbit (944)
# - –£ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –°–ê–° –≤–∞—Ä—å–∏—Ä–æ–≤–∞–ª–∞—Å—å –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –æ—Ç 0 –¥–æ 50 –¥–æ–ª–ª–∞—Ä–æ–≤, –æ–¥–Ω–∞–∫–æ —É –¥–≤—É—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (TipTop –∏ FaceBoom) –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å –ø—Ä–µ–≤—ã—Å–∏–ª 100 –¥–æ–ª–ª–∞—Ä–æ–≤, –∞ –≤ –Ω–∞—á–∞–ª–µ –æ–∫—Ç—è–±—Ä—è 2019 –°–ê–° TipTop –¥–æ—Å—Ç–∏–≥ 600 –¥–æ–ª–ª–∞—Ä–æ–≤
# - –í –¥–∏–Ω–∞–º–∏–∫–µ —Ä–∞—Å—Ö–æ–¥–æ–≤ –ø–æ –Ω–µ–¥–µ–ª—è–º –≤—ã–¥–µ—è—é—Ç—Å—è –¥–≤–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ - TipTop –∏ FaceBoom, —É –æ–±–æ–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –±—ã–ª –ø–∏–∫ –ø–æ —Ä–∞—Å—Ö–æ–¥–∞–º –Ω–∞ 39 –Ω–µ–¥–µ–ª–µ
# - –ü–∏–∫ —Ä–∞—Å—Ö–æ–¥–æ–≤ –ø–æ –º–µ—Å—è—Ü–∞–º —É –¥–≤—É—Ö —Å–∞–º—ã—Ö –∑–∞—Ç—Ä–∞—Ç–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤: TipTop - —Å–µ–Ω—Ç—è–±—Ä—å, FaceBoom - –∞–≤–≥—É—Å—Ç
# - –õ–∏–¥–µ—Ä –ø–æ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è - TipTop (–æ–∫–æ–ª–æ 3.5 –¥–æ–ª–ª–∞—Ä–æ–≤)

# ### –û—Ü–µ–Ω–∏—Ç–µ –æ–∫—É–ø–∞–µ–º–æ—Å—Ç—å —Ä–µ–∫–ª–∞–º—ã
# 
# –ò—Å–ø–æ–ª—å–∑—É—è –≥—Ä–∞—Ñ–∏–∫–∏ LTV, ROI –∏ CAC, –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –æ–∫—É–ø–∞–µ–º–æ—Å—Ç—å —Ä–µ–∫–ª–∞–º—ã. –°—á–∏—Ç–∞–π—Ç–µ, —á—Ç–æ –Ω–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ 1 –Ω–æ—è–±—Ä—è 2019 –≥–æ–¥–∞, –∞ –≤ –±–∏–∑–Ω–µ—Å-–ø–ª–∞–Ω–µ –∑–∞–ª–æ–∂–µ–Ω–æ, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –¥–æ–ª–∂–Ω—ã –æ–∫—É–ø–∞—Ç—å—Å—è –Ω–µ –ø–æ–∑–¥–Ω–µ–µ —á–µ–º —á–µ—Ä–µ–∑ –¥–≤–µ –Ω–µ–¥–µ–ª–∏ –ø–æ—Å–ª–µ –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –≤–∫–ª—é—á–µ–Ω–∏—è –≤ –∞–Ω–∞–ª–∏–∑ –æ—Ä–≥–∞–Ω–∏—á–µ—Å–∫–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–ø—Ä–µ–¥–µ–ª–∏—Ç–µ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ.
# 
# - –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –æ–∫—É–ø–∞–µ–º–æ—Å—Ç—å —Ä–µ–∫–ª–∞–º—ã c –ø–æ–º–æ—â—å—é –≥—Ä–∞—Ñ–∏–∫–æ–≤ LTV –∏ ROI, –∞ —Ç–∞–∫–∂–µ –≥—Ä–∞—Ñ–∏–∫–∏ –¥–∏–Ω–∞–º–∏–∫–∏ LTV, CAC –∏ ROI.
# - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω–≤–µ—Ä—Å–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –¥–∏–Ω–∞–º–∏–∫—É –µ—ë –∏–∑–º–µ–Ω–µ–Ω–∏—è. –¢–æ –∂–µ —Å–∞–º–æ–µ —Å–¥–µ–ª–∞–π—Ç–µ —Å —É–¥–µ—Ä–∂–∞–Ω–∏–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. –ü–æ—Å—Ç—Ä–æ–π—Ç–µ –∏ –∏–∑—É—á–∏—Ç–µ –≥—Ä–∞—Ñ–∏–∫–∏ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏ –∏ —É–¥–µ—Ä–∂–∞–Ω–∏—è.
# - –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –æ–∫—É–ø–∞–µ–º–æ—Å—Ç—å —Ä–µ–∫–ª–∞–º—ã —Å —Ä–∞–∑–±–∏–≤–∫–æ–π –ø–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º. –ü–æ—Å—Ç—Ä–æ–π—Ç–µ –≥—Ä–∞—Ñ–∏–∫–∏ LTV –∏ ROI, –∞ —Ç–∞–∫–∂–µ –≥—Ä–∞—Ñ–∏–∫–∏ –¥–∏–Ω–∞–º–∏–∫–∏ LTV, CAC –∏ ROI.
# - –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –æ–∫—É–ø–∞–µ–º–æ—Å—Ç—å —Ä–µ–∫–ª–∞–º—ã —Å —Ä–∞–∑–±–∏–≤–∫–æ–π –ø–æ —Å—Ç—Ä–∞–Ω–∞–º. –ü–æ—Å—Ç—Ä–æ–π—Ç–µ –≥—Ä–∞—Ñ–∏–∫–∏ LTV –∏ ROI, –∞ —Ç–∞–∫–∂–µ –≥—Ä–∞—Ñ–∏–∫–∏ –¥–∏–Ω–∞–º–∏–∫–∏ LTV, CAC –∏ ROI.
# - –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –æ–∫—É–ø–∞–µ–º–æ—Å—Ç—å —Ä–µ–∫–ª–∞–º—ã —Å —Ä–∞–∑–±–∏–≤–∫–æ–π –ø–æ —Ä–µ–∫–ª–∞–º–Ω—ã–º –∫–∞–Ω–∞–ª–∞–º. –ü–æ—Å—Ç—Ä–æ–π—Ç–µ –≥—Ä–∞—Ñ–∏–∫–∏ LTV –∏ ROI, –∞ —Ç–∞–∫–∂–µ –≥—Ä–∞—Ñ–∏–∫–∏ –¥–∏–Ω–∞–º–∏–∫–∏ LTV, CAC –∏ ROI.
# - –û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ —Ç–∞–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã:
#     - –û–∫—É–ø–∞–µ—Ç—Å—è –ª–∏ —Ä–µ–∫–ª–∞–º–∞, –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –Ω–∞ –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ —Ü–µ–ª–æ–º?
#     - –ö–∞–∫–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞, —Å—Ç—Ä–∞–Ω—ã –∏ —Ä–µ–∫–ª–∞–º–Ω—ã–µ –∫–∞–Ω–∞–ª—ã –º–æ–≥—É—Ç –æ–∫–∞–∑—ã–≤–∞—Ç—å –Ω–µ–≥–∞—Ç–∏–≤–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ –Ω–∞ –æ–∫—É–ø–∞–µ–º–æ—Å—Ç—å —Ä–µ–∫–ª–∞–º—ã?
#     - –ß–µ–º –º–æ–≥—É—Ç –±—ã—Ç—å –≤—ã–∑–≤–∞–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã –æ–∫—É–ø–∞–µ–º–æ—Å—Ç–∏?
# 
# –ù–∞–ø–∏—à–∏—Ç–µ –≤—ã–≤–æ–¥, –æ–ø–∏—à–∏—Ç–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º –∏ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è —Ä–µ–∫–ª–∞–º–Ω–æ–≥–æ –æ—Ç–¥–µ–ª–∞.

# **–ò—Å–∫–ª—é—á–∏–º –∏–∑ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –∫–∞–Ω–∞–ª–æ–º –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è organic, —á—Ç–æ–±—ã –Ω–µ –∏—Å–∫–∞–∂–∞—Ç—å –¥–∞–Ω–Ω—ã–µ**

# In[261]:


profiles = profiles.query('channel != "organic"')


# In[262]:


# —Å—á–∏—Ç–∞–µ–º LTV –∏ ROI
ltv_raw, ltv_grouped, ltv_history, roi_grouped, roi_history = get_ltv(
    profiles, orders, observation_date, horizon_days
)

# —Å—Ç—Ä–æ–∏–º –≥—Ä–∞—Ñ–∏–∫–∏
plot_ltv_roi(ltv_grouped, ltv_history, roi_grouped, roi_history, horizon_days) 


# - –ò–∑ –≥—Ä–∞—Ñ–∏–∫–∞ –°–ê–° —Å—Ä–∞–∑—É –≤–∏–¥–Ω–æ, —á—Ç–æ —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Ä–µ–∑–∫–æ –≤—ã—Ä–æ—Å–ª–∞ –≤ –∏—é–Ω–µ 2019 –≥–æ–¥–∞
# - –†–µ–∫–ª–∞–º–∞ –Ω–µ –æ–∫—É–ø–∞–µ—Ç—Å—è, –≤ –∏—é–Ω–µ –Ω–∞—á–∞–ª—Å—è —Ä–µ–∑–∫–∏–π —Å–ø–∞–¥ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è ROI, —á—Ç–æ —Ç–∞–∫–∂–µ —Å–≤—è–∑–∞–Ω–æ —Å —É–≤–µ–ª–∏—á–µ–Ω–∏–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞

# –ü–æ–ª—É—á–∏–º —Ç–µ–ø–ª–æ–≤—É—é –∫–∞—Ä—Ç—É –∏ –∫—Ä–∏–≤—É—é –∫–æ–Ω–≤–µ—Ä—Å–∏–∏

# In[263]:


conversion_raw, conversion, conversion_history = get_conversion(
    profiles, orders, observation_date, horizon_days
)
plt.figure(figsize=(20, 5)) # —Ä–∞–∑–º–µ—Ä —Å–µ—Ç–∫–∏ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤

# —É–¥–∞–ª–∏—Ç–µ —Å—Ç–æ–ª–±–µ—Ü —Å —Ä–∞–∑–º–µ—Ä–∞–º–∏ –∫–æ–≥–æ—Ä—Ç –∏–∑ —Ç–∞–±–ª–∏—Ü—ã –∫–æ–Ω–≤–µ—Ä—Å–∏–∏
report = conversion.drop(columns=['cohort_size'])
# –ø–æ—Å—Ç—Ä–æ–π—Ç–µ –∫—Ä–∏–≤—ã–µ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏
report.T.plot(
    grid=True, xticks=list(report.columns.values), ax=plt.subplot(1, 2, 2)
)
plt.title('–ö—Ä–∏–≤–∞—è –∫–æ–Ω–≤–µ—Ä—Å–∏–∏')
# –ø–æ—Å—Ç—Ä–æ–π—Ç–µ —Ç–µ–ø–ª–æ–≤—É—é –∫–∞—Ä—Ç—É
sns.heatmap(
    report, annot=True, fmt='.2%', ax=plt.subplot(1, 2, 1)
) 
plt.title('–¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏')

plt.show()


# –ü–æ—Å–º–æ—Ç—Ä–∏–º –Ω–∞ —É–¥–µ—Ä–∂–∞–Ω–∏–µ –¥–ª—è –ø–ª–∞—Ç—è—â–∏—Ö –∏ –Ω–µ–ø–ª–∞—Ç—è—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

# In[264]:


# —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —É–¥–µ—Ä–∂–∞–Ω–∏–µ —Å —É—á—ë—Ç–æ–º —Å–æ–≤–µ—Ä—à–µ–Ω–∏—è –ø–æ–∫—É–ø–∫–∏

retention_raw, retention = get_retention(
    profiles, visits, observation_date, horizon_days, dimensions=['payer']
)  # –ø–µ—Ä–µ–¥–∞—ë–º –ø–∞—Ä–∞–º–µ—Ç—Ä—É dimensions —Å—Ç–æ–ª–±–µ—Ü payer

report = retention.drop(columns=['cohort_size', 0])
report.T.plot(grid=True, xticks=list(report.columns.values), figsize=(15, 5))
plt.xlabel('–õ–∞–π—Ñ—Ç–∞–π–º')
plt.title('–ö—Ä–∏–≤—ã–µ —É–¥–µ—Ä–∂–∞–Ω–∏—è —Å —Ä–∞–∑–±–∏–≤–∫–æ–π –ø–æ —Å–æ–≤–µ—Ä—à–µ–Ω–∏—é –ø–æ–∫—É–ø–æ–∫')
plt.show()


# –£–¥–µ—Ä–∂–∞–Ω–∏–µ –ø–ª–∞—Ç—è—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–∂–∏–¥–∞–µ–º–æ –≤—ã—à–µ, —á–µ–º —É –Ω–µ–ø–ª–∞—Ç—è—â–∏—Ö

# <div class="alert alert-danger">
#     <s><b>üòî –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å:</b> –Ø—á–µ–π–∫–∞ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ —Ç—Ä–µ–Ω–∞–∂–µ—Ä–µ</s>
# </div>

# –ü–æ –≥—Ä–∞—Ñ–∏–∫—É —É–¥–µ—Ä–∂–∞–Ω–∏—è –º–æ–∂–Ω–æ –∑–∞–º–µ—Ç–∏—Ç—å —Å–∏–ª—å–Ω—ã–µ —Å–∫–∞—á–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—Ä–µ–º–µ–Ω–∏

# –†–∞–∑–±–∏–≤–∫–∞ –ø–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º

# In[265]:


# —Å–º–æ—Ç—Ä–∏–º –æ–∫—É–ø–∞–µ–º–æ—Å—Ç—å —Å —Ä–∞–∑–±–∏–≤–∫–æ–π –ø–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º

dimensions = ['device']

ltv_raw, ltv_grouped, ltv_history, roi_grouped, roi_history = get_ltv(
    profiles, orders, observation_date, horizon_days, dimensions=dimensions
)

plot_ltv_roi(
    ltv_grouped, ltv_history, roi_grouped, roi_history, horizon_days, window=14
) 


# –í –≥—Ä–∞—Ñ–∏–∫–∞—Ö —Å —Ä–∞–∑–±–∏–≤–∫–æ–π –ø–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º –≤—Å–µ –¥–æ–≤–æ–ª—å–Ω–æ –æ–¥–Ω–æ—Ä–æ–¥–Ω–æ, —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è –≤—ã—Ä–æ—Å–ª–∞ –¥–ª—è –≤—Å–µ—Ö, ROI —Ç–∞–∫–∂–µ –≤—ã—Ä–æ—Å –¥–ª—è –≤—Å–µ—Ö, –æ–¥–Ω–∞–∫–æ –≤ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –Ω—É–∂–Ω–æ –æ—Ç–º–µ—Ç–∏—Ç—å –Ω–µ–æ–∫—É–ø–∞–µ–º–æ—Å—Ç—å —Ä–µ–∫–ª–∞–º—ã —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π Iphone –∏ Mac

# –û–∫—É–ø–∞–µ–º–æ—Å—Ç—å —Å —Ä–∞–∑–±–∏–≤–∫–æ–π –ø–æ —Å—Ç—Ä–∞–Ω–∞–º

# In[266]:


# —Å–º–æ—Ç—Ä–∏–º –æ–∫—É–ø–∞–µ–º–æ—Å—Ç—å —Å —Ä–∞–∑–±–∏–≤–∫–æ–π –ø–æ —Å—Ç—Ä–∞–Ω–∞–º

dimensions = ['region']

ltv_raw, ltv_grouped, ltv_history, roi_grouped, roi_history = get_ltv(
    profiles, orders, observation_date, horizon_days, dimensions=dimensions
)

plot_ltv_roi(
    ltv_grouped, ltv_history, roi_grouped, roi_history, horizon_days, window=14
) 


# In[267]:


visits.groupby('region').agg({'user_id': 'nunique'}).sort_values(by='user_id', ascending=False)


# –ö–∞–∫ –≤–∏–¥–Ω–æ, –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–∏—Ö–æ–¥–∏—Ç –∏–º–µ–Ω–Ω–æ –∏–∑ —Å—à–∞

# –í —Ä–∞–∑–±–∏–≤–∫–µ –ø–æ —Å—Ç—Ä–∞–Ω–∞–º —è–≤–Ω–æ –≤—ã–¥–µ–ª—è–µ—Ç—Å—è –°–®–ê - —Ç–æ–ª—å–∫–æ —É –°–®–ê –≤—ã—Ä–æ—Å —Ä–µ–∑–∫–æ –≤—ã—Ä–æ—Å –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å –°–ê–° –≤ –∏—é–Ω–µ 2019 –≥–æ–¥–∞, —á—Ç–æ –ø–æ–≤–ª–∏—è–ª–æ –Ω–∞ –æ–±—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É, –∞ —Ç–∞–∫–∂–µ —Ç–æ–ª—å–∫–æ —É –°–®–ê —Ä–µ–∫–ª–∞–º–∞ –Ω–µ –æ–∫—É–ø–∞–µ—Ç—Å—è, –æ–¥–Ω–∞–∫–æ –ª–∞–π—Ñ—Ç–∞–π–º —É –°–®–ê —Å–∞–º—ã–π –≤—ã—Å–æ–∫–∏–π –∏–∑ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å—Ç—Ä–∞–Ω

# –û–∫—É–ø–∞–µ–º–æ—Å—Ç—å —Å —Ä–∞–∑–±–∏–≤–∫–æ–π –ø–æ –∫–∞–Ω–∞–ª–∞–º

# In[268]:


# —Å–º–æ—Ç—Ä–∏–º –æ–∫—É–ø–∞–µ–º–æ—Å—Ç—å —Å —Ä–∞–∑–±–∏–≤–∫–æ–π –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è

dimensions = ['channel']

ltv_raw, ltv_grouped, ltv_history, roi_grouped, roi_history = get_ltv(
    profiles, orders, observation_date, horizon_days, dimensions=dimensions
)

plot_ltv_roi(
    ltv_grouped, ltv_history, roi_grouped, roi_history, horizon_days, window=14
) 


# –ò—Å–∫–ª—é—á–∏–º –∏—Å—Ç–æ—á–Ω–∏–∫ organic

# In[272]:


visits = visits.query('channel != "organic"')


# In[273]:


visits.groupby('channel').agg({'user_id': 'nunique'}).sort_values(by='user_id', ascending=False)


# –ù–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ–∫—É–ø–∞–µ–º–æ—Å—Ç–∏, –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ –ª—é–¥–µ–π –ø—Ä–∏—à–ª–æ –∏–º–µ–Ω–Ω–æ –∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ TipTop –∏ FaceBoom, —Å—É–¥—è –ø–æ –≤—Å–µ–º—É, —ç—Ç–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –æ–±–ª–∞–¥–∞—é—Ç –Ω–∞–∏–º–µ–Ω—å—à–∏–º –ø—Ä–æ—Ü–µ–Ω—Ç–æ–º —É–¥–µ—Ä–∂–∞–Ω–∏—è.

# - –í —Ä–∞–∑–±–∏–≤–∫–µ –ø–æ –∫–∞–Ω–∞–ª–∞–º –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è –≤—ã–¥–µ–ª—è–µ—Ç—Å—è –∏—Å—Ç–æ—á–Ω–∏–∫ TipTop, —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –Ω–µ–º —Ç–∞–∫–∂–µ —Ä–µ–∑–∫–æ –≤—ã—Ä–æ—Å–ª–∞ –≤ –∏–Ω–µ 2019 –≥–æ–¥–∞
# - –ü–æ–º–∏–º–æ –Ω–µ–≥–æ, —Ä–µ–∫–ª–∞–º–∞ —Ç–∞–∫–∂–µ –Ω–µ –æ–∫—É–ø–∞–µ—Ç—Å—è —É –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ FaceBoom –∏ AdNonSense, –æ–¥–Ω–∞–∫–æ –∏—Å—Ö–æ–¥—è –∏–∑ —Ç–∞–±–ª–∏–ª—Ü—ã —Å —Ç—Ä–∞—Ç–∞–º–∏ –Ω–∞ —Ä–µ–∫–ª–∞–º–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏, –∏–º–µ–Ω–Ω–æ –Ω–∞ —ç—Ç–∏ –∫–∞–Ω–∞–ª—ã –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è –±—ã–ª–æ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ —Å—Ä–µ–¥—Å—Ç–≤

# –ü—Ä–æ–≤–µ—Ä–∏–º —É–¥–µ—Ä–∂–∞–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è

# In[274]:


plot_retention(retention_grouped, retention_history, horizon_days)


# –£–¥–µ—Ä–∂–∞–Ω–∏–µ —É –∫–∞–Ω–∞–ª–æ–≤ FaceBoom –∏ AdNonSense –≥–æ—Ä–∞–∑–¥–æ –Ω–∏–∂–µ, —á–µ–º —É –æ—Å—Ç–∞–ª—å–Ω—ã—Ö. –£–¥–µ—Ä–∂–∞–Ω–∏–µ —É –∫–∞–Ω–∞–ª–∞ TipTop –º–∞–ª–æ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤, —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –ø—Ä–∏—á–∏–Ω–∞ –Ω–µ–æ–∫—É–ø–∞–µ–º–æ—Å—Ç–∏ - –≤—ã—Å–æ–∫–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è.

# ### –ù–∞–ø–∏—à–∏—Ç–µ –≤—ã–≤–æ–¥—ã
# 
# - –í—ã–¥–µ–ª–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—ã –Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
# - –°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π—Ç–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –æ—Ç–¥–µ–ª–∞ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞.

# –í —Ö–æ–¥–µ –∞–Ω–∞–ª–∏–∑–∞ –±—ã–ª–æ –≤—ã—è–≤–ª–µ–Ω–æ:
# - –ë–æ–ª—å—à–µ –≤—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ –°–®–ê, –º–µ–Ω—å—à–µ –≤—Å–µ–≥–æ –∏–∑ –ì–µ—Ä–º–∞–Ω–∏–∏. –ë–æ–ª—å—à–µ –≤—Å–µ–≥–æ –ø–ª–∞—Ç—è—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –°–®–ê, –º–µ–Ω—å—à–µ –≤—Å–µ–≥–æ - –≤–æ –§—Ä–∞–Ω—Ü–∏–∏
# - –ö–ª–∏–µ–Ω—Ç—ã —á–∞—â–µ –ø–æ–ª—å–∑—É—é—Ç—Å—è iPhone (54479), –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ –ø–ª–∞—Ç—è—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Ç–∞–∫–∂–µ –æ—Ç—Ç—É–¥–∞, —Ä–µ–∂–µ –≤—Å–µ–≥–æ - –ú–∞—Å (30042). –ú–µ–Ω—å—à–µ –ø–ª–∞—Ç—è—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–∏—Ö–æ–¥–∏—Ç –∏–∑ –†–°
# - –°–∞–º—ã–π –ø–æ–ø—É–ª—è—Ä–Ω—ã–π –∫–∞–Ω–∞–ª - FaceBoom(56439), –Ω–∞–∏–º–µ–Ω–µ–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã–π - lambdaMediaAds(2149). –ë–æ–ª—å—à–µ –≤—Å–µ–≥–æ –ø–ª–∞—Ç—è—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–∏—à–ª–æ –∏–∑ –∫–∞–Ω–∞–ª–∞ FaceBoom, –º–µ–Ω—å—à–µ - –∏–∑ OppleCreativeMedia
# 
# –ë—ã–ª–∞ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –æ–∫—É–ø–∞–µ–º–æ—Å—Ç—å —Ä–µ–∫–ª–∞–º—ã:
# - –ü–æ—Å—á–∏—Ç–∞–Ω–∞ –æ–±—â–∞—è —Å—É–º–º–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤ –Ω–∞ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥ - 105497
# - –ë–æ–ª—å—à–µ –≤—Å–µ–≥–æ –¥–µ–Ω–µ–≥ –±—ã–ª–æ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫ TipTop (54751), –º–µ–Ω—å—à–µ –≤—Å–µ–≥–æ (–µ—Å–ª–∏ –Ω–µ —É—á–∏—Ç—ã–≤–∞—Ç—å organic, —Ç.–∫. —Ç–∞–º –±—É–¥–µ—Ç 0) - YRabbit (944)
# - –£ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –°–ê–° –≤–∞—Ä—å–∏—Ä–æ–≤–∞–ª–∞—Å—å –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –æ—Ç 0 –¥–æ 50 –¥–æ–ª–ª–∞—Ä–æ–≤, –æ–¥–Ω–∞–∫–æ —É –¥–≤—É—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (TipTop –∏ FaceBoom) –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å –ø—Ä–µ–≤—ã—Å–∏–ª 100 –¥–æ–ª–ª–∞—Ä–æ–≤, –∞ –≤ –Ω–∞—á–∞–ª–µ –æ–∫—Ç—è–±—Ä—è 2019 –°–ê–° TipTop –¥–æ—Å—Ç–∏–≥ 600 –¥–æ–ª–ª–∞—Ä–æ–≤
# - –í –¥–∏–Ω–∞–º–∏–∫–µ —Ä–∞—Å—Ö–æ–¥–æ–≤ –ø–æ –Ω–µ–¥–µ–ª—è–º –≤—ã–¥–µ—è—é—Ç—Å—è –¥–≤–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ - TipTop –∏ FaceBoom, —É –æ–±–æ–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –±—ã–ª –ø–∏–∫ –ø–æ —Ä–∞—Å—Ö–æ–¥–∞–º –Ω–∞ 39 –Ω–µ–¥–µ–ª–µ
# - –ü–∏–∫ —Ä–∞—Å—Ö–æ–¥–æ–≤ –ø–æ –º–µ—Å—è—Ü–∞–º —É –¥–≤—É—Ö —Å–∞–º—ã—Ö –∑–∞—Ç—Ä–∞—Ç–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤: TipTop - —Å–µ–Ω—Ç—è–±—Ä—å, FaceBoom - –∞–≤–≥—É—Å—Ç
# - –õ–∏–¥–µ—Ä –ø–æ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è - TipTop (–æ–∫–æ–ª–æ 3.5 –¥–æ–ª–ª–∞—Ä–æ–≤)
# - –õ–∏–¥–µ—Ä –ø–æ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ —Å—Ç—Ä–∞–Ω–∞–º - –°–®–ê
# 
# –°—Ä–µ–¥–∏ –ø—Ä–∏—á–∏–Ω –Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –º–æ–≥—É—Ç –±—ã—Ç—å —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∏–µ —Ç—Ä–∞—Ç—ã –Ω–∞ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏:
# - –ò—Å—Ç–æ—á–Ω–∏–∫–∏ FaceBoom –∏ AdNonSense —è–≤–ª—è—é—Ç—Å—è –Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–º–∏ - –æ–Ω–∏ –Ω–µ –æ–∫—É–ø–∞—é—Ç —Å–µ–±—è –∏ –æ–±–ª–∞–¥–∞—é—Ç —Ä–µ–∫–æ—Ä–¥–Ω–æ –Ω–∏–∑–∫–∏–º —É–¥–µ—Ä–∂–∞–Ω–∏–µ–º, –ø–æ—ç
